# .env.email - Credentials Chiffrés

**Date** : 2026-02-12
**Fichier chiffré** : `.env.email.enc`
**Méthode** : SOPS + age encryption

---

## ⚠️ IMPORTANT

Le fichier `.env.email` contenant les credentials en clair a été **supprimé**.

Seule la version chiffrée `.env.email.enc` existe maintenant.

---

## Déchiffrement pour Utilisation

### Prérequis

Vous devez avoir la **clé privée age** :
- Emplacement : `~/.age/friday-key.txt` (ou `C:\Users\lopez\.age\friday-key.txt` sur Windows)
- Format : `AGE-SECRET-KEY-...`

**Si vous n'avez pas la clé privée, vous ne pourrez PAS déchiffrer.**

---

### Méthode 1 : Déchiffrement Temporaire (Recommandé)

```bash
# Déchiffrer en mémoire pour utilisation immédiate
export $(sops -d .env.email.enc | xargs)

# Vérifier
echo $GMAIL_PRO_EMAIL
# Doit afficher: lopez.tonio@gmail.com

# Utiliser immédiatement
python scripts/setup_emailengine_4accounts.py

# Les variables sont chargées, mais rien n'est écrit sur disque ✅
```

---

### Méthode 2 : Déchiffrement Fichier (Usage Ponctuel)

```bash
# Déchiffrer vers fichier temporaire
sops -d .env.email.enc > .env.email

# Utiliser
export $(cat .env.email | xargs)
python scripts/setup_emailengine_4accounts.py

# ⚠️ IMPORTANT : Supprimer immédiatement après usage
rm .env.email
```

**JAMAIS** laisser `.env.email` non chiffré sur disque.

---

### Méthode 3 : Édition In-Place (Modification Credentials)

```bash
# Éditer le fichier chiffré directement
sops .env.email.enc

# SOPS déchiffre temporairement, ouvre l'éditeur
# Vous modifiez les valeurs
# À la sauvegarde, SOPS rechiffre automatiquement
```

---

## Configuration Clé age (Si Manquante)

### Vérifier Clé Existante

```bash
# Windows
cat C:\Users\lopez\.age\friday-key.txt

# Linux/macOS
cat ~/.age/friday-key.txt
```

**Si la clé existe**, vérifier qu'elle est référencée par SOPS :

```bash
# Windows : Créer variable d'environnement
setx SOPS_AGE_KEY_FILE "C:\Users\lopez\.age\friday-key.txt"

# Linux/macOS : Ajouter dans ~/.bashrc ou ~/.zshrc
export SOPS_AGE_KEY_FILE=~/.age/friday-key.txt
```

---

### Générer Nouvelle Clé (Si Perdue)

**⚠️ ATTENTION : Si vous générez une nouvelle clé, vous devrez re-chiffrer TOUS les fichiers secrets.**

```bash
# Générer clé
age-keygen -o ~/.age/friday-key.txt

# Extraire clé publique
cat ~/.age/friday-key.txt | grep "public key:"
# Copier: age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Mettre à jour .sops.yaml
# Remplacer l'ancienne clé publique par la nouvelle

# Re-chiffrer tous les fichiers
sops updatekeys .env.email.enc
sops updatekeys .env.enc
# (répéter pour tous les *.enc)
```

---

## Déploiement VPS

### Transfer Sécurisé

```bash
# Option 1 : Via Tailscale (recommandé)
# Sur PC
sops -d .env.email.enc > /tmp/.env.email
scp /tmp/.env.email friday-vps:/opt/friday/.env.email
rm /tmp/.env.email

# Option 2 : Copier version chiffrée + déchiffrer sur VPS
scp .env.email.enc friday-vps:/opt/friday/.env.email.enc

# Sur VPS (si clé age installée)
cd /opt/friday
sops -d .env.email.enc > .env.email
export $(cat .env.email | xargs)
python scripts/setup_emailengine_4accounts.py
rm .env.email  # Supprimer après usage
```

---

## Credentials Contenus

Le fichier `.env.email.enc` contient les credentials pour :

1. **Gmail Pro** : lopez.tonio@gmail.com (App Password)
2. **Gmail Perso** : contact.antoniolopez@gmail.com (App Password)
3. **Zimbra Université** : antonio.lopez@umontpellier.fr (Password)
4. **ProtonMail** : contact.antoniolopez@proton.me (Bridge Token)

---

## Sécurité

✅ **Sécurisé** :
- `.env.email.enc` chiffré avec age (peut être commité sur Git)
- `.sops.yaml` contient seulement la clé **publique** (peut être commité)

❌ **JAMAIS Commiter** :
- `.env.email` (credentials en clair)
- `~/.age/friday-key.txt` (clé privée age)
- Tout fichier `*.age` non chiffré

---

## Troubleshooting

### Erreur : "failed to load age identities"

```
Failed to get the data key required to decrypt the SOPS file.
failed to open file: C:\Users\lopez\AppData\Roaming\sops\age\keys.txt
```

**Solution** :

```bash
# Créer le répertoire
mkdir -p C:\Users\lopez\AppData\Roaming\sops\age

# Copier votre clé age
copy C:\Users\lopez\.age\friday-key.txt C:\Users\lopez\AppData\Roaming\sops\age\keys.txt

# OU définir variable d'environnement
setx SOPS_AGE_KEY_FILE "C:\Users\lopez\.age\friday-key.txt"
```

---

### Erreur : "MAC mismatch"

Le fichier a été corrompu ou modifié.

**Solution** : Restaurer depuis backup Git ou régénérer.

---

## Backup Clé Privée

**CRITIQUE** : Sauvegarder la clé privée age dans un endroit sûr.

```bash
# Sauvegarder sur clé USB chiffrée
cp ~/.age/friday-key.txt /media/usb/friday-backup/age-key-backup-2026-02-12.txt

# OU imprimer sur papier (si vraiment paranoïaque)
cat ~/.age/friday-key.txt
# Écrire manuellement la clé sur papier, stocker dans coffre
```

**Sans la clé privée, les credentials sont IRRÉCUPÉRABLES.**

---

**Date création** : 2026-02-12
**Dernière modification** : 2026-02-12
