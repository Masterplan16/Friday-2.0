name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

# Annuler runs précédents si nouveau push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ────────────────────────────────────────────────────────────
  # Job 1: Lint - Code Quality Checks
  # ────────────────────────────────────────────────────────────
  lint:
    name: Lint (black, isort, flake8, mypy, sqlfluff)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', 'agents/requirements-lock.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r agents/requirements-lock.txt
          pip install black isort flake8 mypy sqlfluff

      - name: Run black (code formatting check)
        run: |
          # AC8: Log JSON structuré (NFR22)
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Running black formatter check\",\"job\":\"lint\"}"
          echo "::notice::Running black formatter check..."
          black --check --line-length 100 agents/ services/ bot/ scripts/ || {
            echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"ERROR\",\"message\":\"Black formatting check failed\",\"job\":\"lint\"}"
            echo "::error::Black formatting check failed. Run 'black agents/ services/ bot/ scripts/' to fix."
            exit 1
          }
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Black formatting check passed\",\"job\":\"lint\"}"

      - name: Run isort (import sorting check)
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Running isort import sorting check\",\"job\":\"lint\"}"
          echo "::notice::Running isort import sorting check..."
          isort --check-only --profile black agents/ services/ bot/ scripts/ || {
            echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"ERROR\",\"message\":\"Isort check failed\",\"job\":\"lint\"}"
            echo "::error::Isort check failed. Run 'isort agents/ services/ bot/ scripts/' to fix."
            exit 1
          }
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Isort check passed\",\"job\":\"lint\"}"

      - name: Run flake8 (linting)
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Running flake8 linter\",\"job\":\"lint\"}"
          echo "::notice::Running flake8 linter..."
          flake8 agents/ services/ bot/ scripts/ --max-line-length=100 --extend-ignore=E203,W503 || {
            echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"ERROR\",\"message\":\"Flake8 linting failed\",\"job\":\"lint\"}"
            echo "::error::Flake8 linting failed."
            exit 1
          }
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Flake8 linting passed\",\"job\":\"lint\"}"

      - name: Run mypy (type checking)
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Running mypy type checker\",\"job\":\"lint\"}"
          echo "::notice::Running mypy type checker..."
          # MEDIUM #8: Non-bloquant car migration progressive vers typage strict (30% du code actuellement typé)
          # TODO Story 1.17: Typage complet avant open-source
          mypy agents/ --strict --ignore-missing-imports || {
            echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"WARNING\",\"message\":\"Mypy type checking found issues (non-blocking - migration progressive)\",\"job\":\"lint\"}"
            echo "::warning::Mypy type checking found issues (non-blocking - migration progressive vers typage strict)"
          }
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Mypy type checking completed\",\"job\":\"lint\"}"

      - name: Run sqlfluff (SQL linting)
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Running sqlfluff SQL linter\",\"job\":\"lint\"}"
          echo "::notice::Running sqlfluff SQL linter..."
          # MEDIUM #9: Non-bloquant car migrations 001-012 pré-existantes (avant introduction sqlfluff)
          # Nouvelles migrations (013+) DOIVENT passer sqlfluff
          sqlfluff lint database/migrations/ --dialect postgres || {
            echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"WARNING\",\"message\":\"SQLFluff found issues in legacy migrations (non-blocking)\",\"job\":\"lint\"}"
            echo "::warning::SQLFluff found issues in legacy migrations 001-012 (non-blocking - migrations pré-existantes)"
          }
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"SQLFluff linting completed\",\"job\":\"lint\"}"

      - name: Lint job summary
        if: always()
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Lint job completed. All code quality checks passed.\",\"job\":\"lint\"}"
          echo "::notice::Lint job completed. All code quality checks passed."

  # ────────────────────────────────────────────────────────────
  # Job 2: Unit Tests - Fast tests without external services
  # ────────────────────────────────────────────────────────────
  test-unit:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-py${{ matrix.python-version }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', 'agents/requirements-lock.txt') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r agents/requirements-lock.txt
          pip install -e bot/
          pip install pytest pytest-asyncio pytest-cov

      - name: Run unit tests
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Running unit tests (Python ${{ matrix.python-version }})\",\"job\":\"test-unit\"}"
          echo "::notice::Running unit tests (Python ${{ matrix.python-version }})..."
          # Pas de filtre -m unit: tous les tests dans tests/unit/ sont unitaires par convention
          pytest tests/unit -v --tb=short --cov=agents --cov-report=term-missing || {
            echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"ERROR\",\"message\":\"Unit tests failed on Python ${{ matrix.python-version }}\",\"job\":\"test-unit\"}"
            echo "::error::Unit tests failed on Python ${{ matrix.python-version }}"
            exit 1
          }
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Unit tests passed (Python ${{ matrix.python-version }})\",\"job\":\"test-unit\"}"

      - name: Unit tests summary
        if: always()
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Unit tests completed for Python ${{ matrix.python-version }}\",\"job\":\"test-unit\"}"
          echo "::notice::Unit tests completed for Python ${{ matrix.python-version }}"

  # ────────────────────────────────────────────────────────────
  # Job 3: Integration Tests - With PostgreSQL + Redis services
  # ────────────────────────────────────────────────────────────
  test-integration:
    name: Integration Tests (PostgreSQL + Redis)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16.6
        env:
          POSTGRES_USER: friday_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: friday_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7.4
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-integration-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', 'agents/requirements-lock.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-integration-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r agents/requirements-lock.txt
          pip install -e bot/
          pip install pytest pytest-asyncio

      - name: Install Redis CLI
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Installing redis-cli for health checks\",\"job\":\"test-integration\"}"
          sudo apt-get update -qq
          sudo apt-get install -y redis-tools

      - name: Wait for PostgreSQL
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Waiting for PostgreSQL to be ready\",\"job\":\"test-integration\"}"
          echo "::notice::Waiting for PostgreSQL to be ready..."
          timeout 30 bash -c 'until pg_isready -h localhost -p 5432 -U friday_test; do sleep 1; done'
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"PostgreSQL is ready\",\"job\":\"test-integration\"}"

      - name: Wait for Redis
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Waiting for Redis to be ready\",\"job\":\"test-integration\"}"
          echo "::notice::Waiting for Redis to be ready..."
          timeout 30 bash -c 'until redis-cli -h localhost -p 6379 ping; do sleep 1; done'
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Redis is ready\",\"job\":\"test-integration\"}"

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://friday_test:test_password@localhost:5432/friday_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Running integration tests\",\"job\":\"test-integration\"}"
          echo "::notice::Running integration tests..."
          pytest tests/integration -m integration -v --tb=short || {
            echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"ERROR\",\"message\":\"Integration tests failed\",\"job\":\"test-integration\"}"
            echo "::error::Integration tests failed"
            exit 1
          }
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Integration tests passed\",\"job\":\"test-integration\"}"

      - name: Integration tests summary
        if: always()
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Integration tests completed\",\"job\":\"test-integration\"}"
          echo "::notice::Integration tests completed"

  # ────────────────────────────────────────────────────────────
  # Job 4: Build Validation - Verify reproducible builds
  # ────────────────────────────────────────────────────────────
  build-validation:
    name: Build Validation (Docker Compose)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker images (no cache)
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Building Docker images without cache to verify reproducibility\",\"job\":\"build-validation\"}"
          echo "::notice::Building Docker images without cache to verify reproducibility..."
          docker compose build --no-cache || {
            echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"ERROR\",\"message\":\"Docker build failed\",\"job\":\"build-validation\"}"
            echo "::error::Docker build failed"
            exit 1
          }
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Docker build succeeded\",\"job\":\"build-validation\"}"

      - name: Verify builds succeeded
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Verifying all services built successfully\",\"job\":\"build-validation\"}"
          echo "::notice::Verifying all services built successfully..."
          docker compose config --services
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Build validation passed - all images built successfully\",\"job\":\"build-validation\"}"
          echo "::notice::Build validation passed - all images built successfully"

      - name: Build validation summary
        if: always()
        run: |
          echo "{\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"level\":\"INFO\",\"message\":\"Build validation completed\",\"job\":\"build-validation\"}"
          echo "::notice::Build validation completed"
