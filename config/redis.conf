# Friday 2.0 - Redis Configuration
# Story 2.1 Task 5 - Zero email perdu (AOF persistence)
#
# IMPORTANT: AOF (Append Only File) enabled pour garantir zero perte
#
# Source: https://redis.io/docs/manual/persistence/

# ============================================
# Persistence - AOF Mode (Story 2.1 AC5)
# ============================================

# Enable AOF persistence
appendonly yes

# Fsync policy: everysec (compromis perf/durabilité)
# - always: Fsync à chaque commande (très lent, durabilité maximale)
# - everysec: Fsync toutes les secondes (RECOMMANDÉ - perte max 1s)
# - no: Pas de fsync explicite (OS décide, perte possible)
appendfsync everysec

# Nom fichier AOF
appendfilename "appendonly.aof"

# Auto-rewrite AOF si fichier >64MB et croissance >100%
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ============================================
# Memory Management
# ============================================

# Max memory: 2GB (VPS-4 48GB, Redis socle ~1-2GB)
maxmemory 2gb

# Eviction policy: noeviction (CRITIQUE - ne pas perdre d'événements)
# Si RAM pleine → erreur write, mais ne supprime JAMAIS de données
maxmemory-policy noeviction

# ============================================
# Networking
# ============================================

# Bind uniquement sur interface Docker network (pas public)
bind 0.0.0.0

# Port par défaut
port 6379

# Timeout client: 300s
timeout 300

# ============================================
# Security
# ============================================

# ACL: Authentification par user/password
# Voir: config/redis.acl (Story 1.1)
aclfile /usr/local/etc/redis/redis.acl

# Protected mode (désactivé car ACL utilisé)
protected-mode no

# ============================================
# Logging
# ============================================

# Log level: notice (production), debug (dev)
loglevel notice

# Log destination: stdout (Docker logs)
logfile ""

# ============================================
# Slow Log
# ============================================

# Log commandes >10ms
slowlog-log-slower-than 10000

# Garder 128 entrées slow log en mémoire
slowlog-max-len 128

# ============================================
# Redis Streams (Story 2.1)
# ============================================

# Max longueur stream (limite mémoire)
# Après X messages, trim automatique des plus vieux
# Note: Pas de limite par défaut, trim manuel via XTRIM ou consumer XACK
# stream-max-length 100000

# Consumer group idle timeout: 1h
# Si consumer ne répond pas pendant 1h → message reclaim possible
# (géré par script recover-stalled-emails.sh)

# ============================================
# Client Output Buffer Limits
# ============================================

# Limite buffer clients normaux
client-output-buffer-limit normal 0 0 0

# Limite buffer pub/sub (Friday utilise Streams, pas Pub/Sub critique)
client-output-buffer-limit pubsub 32mb 8mb 60

# Limite buffer replicas
client-output-buffer-limit replica 256mb 64mb 60

# ============================================
# Notes Configuration
# ============================================
#
# Monitoring AOF:
#   - docker exec friday-redis redis-cli INFO persistence
#   - Vérifier: aof_enabled:1, aof_current_size, aof_base_size
#
# Recovery si corruption AOF:
#   - docker exec friday-redis redis-check-aof --fix /data/appendonly.aof
#
# Backup AOF:
#   - Copier /data/appendonly.aof (volume Docker emailengine-data)
#
# Performance:
#   - appendfsync everysec = ~100 write/s (suffit largement pour emails)
#   - Si besoin perf: appendfsync no (mais risque perte >1s)
#
