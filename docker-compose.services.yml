# Friday 2.0 - Services lourds résidents (VPS-4 48 Go)
# Faster-Whisper, Kokoro TTS, Surya OCR, Presidio
# Version: 1.2.0 (2026-02-13) — D25: EmailEngine retiré (IMAP direct)
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.services.yml up -d
#
# Note: Ollama retiré (Décision D12 - pas de GPU VPS, Presidio suffit, zéro données ultra-sensibles)

services:
  # ============================================
  # Ollama - RETIRÉ (Décision D12)
  # Raison: Pas de GPU sur VPS, Presidio suffit pour anonymisation,
  # zéro données ultra-sensibles nécessitant LLM local
  # ============================================
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: friday-ollama
  #   restart: unless-stopped
  #   environment:
  #     - OLLAMA_HOST=0.0.0.0
  #     - OLLAMA_MODELS=/models
  #   volumes:
  #     - ./data/ollama:/root/.ollama
  #     - ./data/models:/models
  #   ports:
  #     - "127.0.0.1:11434:11434"
  #   networks:
  #     friday-network:
  #       ipv4_address: 172.20.0.30
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 10G
  #       reservations:
  #         memory: 8G
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:11434/api/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 60s

  # ============================================
  # Faster-Whisper - STT local
  # RAM: ~4 Go
  # ============================================
  stt:
    build:
      context: ./services/stt
      dockerfile: Dockerfile
    container_name: friday-stt
    restart: unless-stopped
    environment:
      - MODEL_SIZE=large-v3
      - DEVICE=cpu
      - COMPUTE_TYPE=int8
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./services/stt:/app:ro
      - ./data/whisper-models:/models
    ports:
      - "127.0.0.1:8001:8001"
    networks:
      friday-network:
        ipv4_address: 172.20.0.31
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 4G
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ============================================
  # Kokoro TTS - Synthèse vocale
  # RAM: ~2 Go
  # ============================================
  tts:
    build:
      context: ./services/tts
      dockerfile: Dockerfile
    container_name: friday-tts
    restart: unless-stopped
    environment:
      - MODEL=kokoro
      - VOICE=fr-FR
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./services/tts:/app:ro
      - ./data/tts-models:/models
    ports:
      - "127.0.0.1:8002:8002"
    networks:
      friday-network:
        ipv4_address: 172.20.0.32
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8002/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ============================================
  # Surya OCR - Reconnaissance optique
  # RAM: ~2 Go
  # ============================================
  ocr:
    build:
      context: ./services/ocr
      dockerfile: Dockerfile
    container_name: friday-ocr
    restart: unless-stopped
    environment:
      - MODELS_PATH=/models
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./services/ocr:/app:ro
      - ./data/ocr-models:/models
    ports:
      - "127.0.0.1:8003:8003"
    networks:
      friday-network:
        ipv4_address: 172.20.0.33
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # ============================================
  # Presidio - Anonymisation RGPD obligatoire
  # RAM: ~1 Go
  # ============================================
  presidio-analyzer:
    build:
      context: ./docker/presidio-analyzer
      dockerfile: Dockerfile
    image: friday-presidio-analyzer:2.2.354-fr
    container_name: friday-presidio-analyzer
    restart: unless-stopped
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SPACY_MODEL=fr_core_news_lg
    ports:
      - "127.0.0.1:5001:3000"
    networks:
      friday-network:
        ipv4_address: 172.20.0.34
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:3000/health')\""]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  presidio-anonymizer:
    image: mcr.microsoft.com/presidio-anonymizer:2.2.354
    container_name: friday-presidio-anonymizer
    restart: unless-stopped
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "127.0.0.1:5002:3000"
    networks:
      friday-network:
        ipv4_address: 172.20.0.35
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:3000/health')\""]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================
  # [RETIRÉ D25] EmailEngine → IMAP Direct (aioimaplib)
  # Raison: 99 EUR/an, latence IMAP IDLE 2-5s acceptable
  # Voir: imap-fetcher dans docker-compose.yml
  # ============================================

  # ============================================
  # Watchtower - Docker Image Monitoring
  # RAM: ~100 Mo
  # Story 1.14 - Monitor-only mode (NO auto-updates)
  # ============================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: friday-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - WATCHTOWER_MONITOR_ONLY=true
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_SCHEDULE=0 0 3 * * *
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=telegram://${TELEGRAM_BOT_TOKEN}@telegram?channels=${TOPIC_SYSTEM_ID}
      - WATCHTOWER_CLEANUP=false
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    networks:
      friday-network:
        # IP fixe pour stabilité logs/monitoring (plage: .30-.40 réservée services infra)
        ipv4_address: 172.20.0.37
    deploy:
      resources:
        limits:
          memory: 200M
        reservations:
          memory: 100M

# ============================================
# Volumes - Persistance données services
# ============================================
# Pas de volumes additionnels (emailengine-data retiré D25)
