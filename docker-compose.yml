# Friday 2.0 - Docker Compose Principal
# Services core pour Story 1 : Infrastructure de base
# Version: 1.2.0 (2026-02-13) — D25: EmailEngine retiré, IMAP direct

networks:
  friday-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres-data:
  redis-data:
  n8n-data:
  caddy-data:
  caddy-config:
  friday_backups:

services:
  # ============================================
  # PostgreSQL 16 - Base de données principale
  # ============================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: friday-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-friday}
      POSTGRES_USER: ${POSTGRES_USER:-friday}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/migrations:/migrations:ro
    ports:
      - "127.0.0.1:5433:5432"  # Port 5433 externe (5432 déjà utilisé)
    networks:
      friday-network:
        ipv4_address: 172.20.0.10
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-friday} -d ${POSTGRES_DB:-friday}"]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=1048kB"

  # ============================================
  # Redis 7 - Cache + Pub/Sub + Streams
  # ============================================
  redis:
    image: redis:7.4-alpine
    container_name: friday-redis
    restart: unless-stopped
    command: >
      redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - redis-data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./config/redis.acl:/usr/local/etc/redis/redis.acl:ro
    ports:
      - "127.0.0.1:6379:6379"
    networks:
      friday-network:
        ipv4_address: 172.20.0.11
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ============================================
  # [RETIRÉ D19] Qdrant → pgvector dans PostgreSQL
  # Raison: 100k vecteurs, 1 utilisateur = pgvector suffit
  # Réévaluation Qdrant si >300k vecteurs ou latence >100ms
  # ============================================

  # ============================================
  # n8n 2.2.4 - Workflow automation
  # Story 1.12: Custom build avec age CLI installé
  # ============================================
  n8n:
    build:
      context: .
      dockerfile: Dockerfile.n8n
    container_name: friday-n8n
    restart: unless-stopped
    environment:
      # Auth - n8n v2 user management (basic auth supprimé en v2)
      # Owner account créé via UI au premier accès
      # Docs: https://docs.n8n.io/hosting/authentication/
      # General
      - N8N_HOST=${N8N_HOST:-n8n.friday.local}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://n8n.friday.local:5678/
      - GENERIC_TIMEZONE=Europe/Paris
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      # Database (PostgreSQL only - MySQL/MariaDB removed in v2)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-friday}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-friday}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_POSTGRESDB_SCHEMA=n8n
      # Executions
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      # n8n v2 security defaults
      - N8N_RESTRICT_FILE_ACCESS_TO=/home/node/.n8n
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      # Story 1.12: Variables backup & sync
      - AGE_PUBLIC_KEY=${AGE_PUBLIC_KEY}
      - TAILSCALE_PC_HOSTNAME=${TAILSCALE_PC_HOSTNAME:-mainteneur-pc}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TOPIC_SYSTEM_ID=${TOPIC_SYSTEM_ID}
    volumes:
      - n8n-data:/home/node/.n8n
      - ./n8n-workflows:/workflows:ro
      - friday_backups:/backups
      - ./scripts:/scripts:ro
      - ./config/ssh:/home/node/.ssh:ro  # FIX H2: SSH key for rsync to PC
    ports:
      - "127.0.0.1:5678:5678"
    networks:
      friday-network:
        ipv4_address: 172.20.0.13
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # Caddy 2.10.2 - Reverse proxy HTTPS auto
  # ============================================
  caddy:
    image: caddy:2.10.2-alpine
    container_name: friday-caddy
    restart: unless-stopped
    ports:
      - "127.0.0.1:80:80"
      - "127.0.0.1:443:443"
      - "127.0.0.1:443:443/udp"
    volumes:
      - ./config/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      friday-network:
        ipv4_address: 172.20.0.14
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ============================================
  # FastAPI Gateway - API principale
  # ============================================
  gateway:
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    container_name: friday-gateway
    restart: unless-stopped
    environment:
      - POSTGRES_DSN=postgresql://${POSTGRES_USER:-friday}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-friday}
      - REDIS_URL=redis://friday_gateway:${REDIS_GATEWAY_PASSWORD}@redis:6379/0
      - API_TOKEN=${API_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-production}
    # Note: gateway code + agents sont copiés dans l'image Docker (pas de volume mount)
    ports:
      - "127.0.0.1:8000:8000"
    networks:
      friday-network:
        ipv4_address: 172.20.0.20
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO /dev/null http://localhost:8000/api/v1/webhooks/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================
  # [RETIRÉ A.1] telegram-bot supprimé — doublon de friday-bot
  # Garder uniquement friday-bot (autonome, sans dépendance gateway)
  # ============================================

  # ============================================
  # Alerting Service - Écoute Redis → Telegram
  # ============================================
  alerting:
    build:
      context: ./services/alerting
      dockerfile: Dockerfile
    container_name: friday-alerting
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - REDIS_URL=redis://friday_alerting:${REDIS_ALERTING_PASSWORD}@redis:6379/0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./services/alerting:/app:ro
    networks:
      friday-network:
        ipv4_address: 172.20.0.22
    depends_on:
      redis:
        condition: service_healthy
    # TODO Story 1.13: Ajouter healthcheck quand alerting est implémenté
    # healthcheck:
    #   test: ["CMD", "wget", "--spider", "-q", "http://localhost:8090/health"]
    #   interval: 30s
    #   timeout: 5s
    #   retries: 3

  # ============================================
  # Metrics Service - Calcul nightly trust metrics
  # ============================================
  metrics:
    build:
      context: ./services/metrics
      dockerfile: Dockerfile
    container_name: friday-metrics
    restart: unless-stopped
    environment:
      - POSTGRES_DSN=postgresql://${POSTGRES_USER:-friday}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-friday}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-friday}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-friday}
      - REDIS_URL=redis://friday_metrics:${REDIS_METRICS_PASSWORD}@redis:6379/0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CRON_SCHEDULE=${METRICS_CRON_SCHEDULE:-0 2 * * *}
      - PYTHONPATH=/opt
    volumes:
      - ./services/metrics:/app:ro
      - ./services:/opt/services:ro
    networks:
      friday-network:
        ipv4_address: 172.20.0.23
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import os; os.kill(1, 0)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ============================================
  # Bot Telegram - Interface utilisateur Friday
  # ============================================
  # Story 1.9 - CRIT-7 fix: Service manquant
  friday-bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    container_name: friday-bot
    restart: unless-stopped
    environment:
      # Token Telegram
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_SUPERGROUP_ID=${TELEGRAM_SUPERGROUP_ID}

      # Thread IDs des 5 topics
      - TOPIC_CHAT_PROACTIVE_ID=${TOPIC_CHAT_PROACTIVE_ID}
      - TOPIC_EMAIL_ID=${TOPIC_EMAIL_ID}
      - TOPIC_ACTIONS_ID=${TOPIC_ACTIONS_ID}
      - TOPIC_SYSTEM_ID=${TOPIC_SYSTEM_ID}
      - TOPIC_METRICS_ID=${TOPIC_METRICS_ID}

      # User ID owner (HIGH-1 fix: obligatoire)
      - OWNER_USER_ID=${OWNER_USER_ID}

      # Database & Redis
      - DATABASE_URL=postgresql://${POSTGRES_USER:-friday}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-friday}
      - REDIS_URL=redis://friday_bot:${REDIS_BOT_PASSWORD}@redis:6379/0

      # Config optionnelle
      - TELEGRAM_CONFIG_PATH=${TELEGRAM_CONFIG_PATH:-config/telegram.yaml}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./bot:/app/bot:ro
      - ./config:/app/config:ro
    networks:
      friday-network:
        ipv4_address: 172.20.0.24
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os; os.kill(1, 0)'"]
      interval: 60s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ============================================
  # Email Processor Consumer - Pipeline email (Epic 2)
  # ============================================
  email-processor:
    build:
      context: .
      dockerfile: Dockerfile.email-processor
    container_name: friday-email-processor
    restart: unless-stopped
    environment:
      # Database & Redis
      - DATABASE_URL=postgresql://${POSTGRES_USER:-friday}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-friday}
      - REDIS_URL=redis://friday_email:${REDIS_EMAIL_PASSWORD}@redis:6379/0
      # Email adapter (D25: IMAP direct remplace EmailEngine)
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-imap_direct}
      # Encryption (pgcrypto pour emails raw)
      - PGP_ENCRYPTION_KEY=${PGP_ENCRYPTION_KEY}
      # IMAP accounts (pour adapter on-demand fetch/send)
      - IMAP_ACCOUNT_GMAIL1_EMAIL=${IMAP_ACCOUNT_GMAIL1_EMAIL}
      - IMAP_ACCOUNT_GMAIL1_IMAP_HOST=${IMAP_ACCOUNT_GMAIL1_IMAP_HOST:-imap.gmail.com}
      - IMAP_ACCOUNT_GMAIL1_IMAP_PORT=${IMAP_ACCOUNT_GMAIL1_IMAP_PORT:-993}
      - IMAP_ACCOUNT_GMAIL1_IMAP_USER=${IMAP_ACCOUNT_GMAIL1_IMAP_USER}
      - IMAP_ACCOUNT_GMAIL1_IMAP_PASSWORD=${IMAP_ACCOUNT_GMAIL1_IMAP_PASSWORD}
      - IMAP_ACCOUNT_GMAIL1_SMTP_HOST=${IMAP_ACCOUNT_GMAIL1_SMTP_HOST:-smtp.gmail.com}
      - IMAP_ACCOUNT_GMAIL1_SMTP_PORT=${IMAP_ACCOUNT_GMAIL1_SMTP_PORT:-587}
      - IMAP_ACCOUNT_UNIVERSITE_EMAIL=${IMAP_ACCOUNT_UNIVERSITE_EMAIL}
      - IMAP_ACCOUNT_UNIVERSITE_IMAP_HOST=${IMAP_ACCOUNT_UNIVERSITE_IMAP_HOST:-imap.gmail.com}
      - IMAP_ACCOUNT_UNIVERSITE_IMAP_PORT=${IMAP_ACCOUNT_UNIVERSITE_IMAP_PORT:-993}
      - IMAP_ACCOUNT_UNIVERSITE_IMAP_USER=${IMAP_ACCOUNT_UNIVERSITE_IMAP_USER}
      - IMAP_ACCOUNT_UNIVERSITE_IMAP_PASSWORD=${IMAP_ACCOUNT_UNIVERSITE_IMAP_PASSWORD}
      - IMAP_ACCOUNT_UNIVERSITE_SMTP_HOST=${IMAP_ACCOUNT_UNIVERSITE_SMTP_HOST:-smtp.gmail.com}
      - IMAP_ACCOUNT_UNIVERSITE_SMTP_PORT=${IMAP_ACCOUNT_UNIVERSITE_SMTP_PORT:-587}
      - IMAP_ACCOUNT_PROTONMAIL_EMAIL=${IMAP_ACCOUNT_PROTONMAIL_EMAIL}
      - IMAP_ACCOUNT_PROTONMAIL_IMAP_HOST=${IMAP_ACCOUNT_PROTONMAIL_IMAP_HOST}
      - IMAP_ACCOUNT_PROTONMAIL_IMAP_PORT=${IMAP_ACCOUNT_PROTONMAIL_IMAP_PORT:-1144}
      - IMAP_ACCOUNT_PROTONMAIL_IMAP_USER=${IMAP_ACCOUNT_PROTONMAIL_IMAP_USER}
      - IMAP_ACCOUNT_PROTONMAIL_IMAP_PASSWORD=${IMAP_ACCOUNT_PROTONMAIL_IMAP_PASSWORD}
      - IMAP_ACCOUNT_PROTONMAIL_SMTP_HOST=${IMAP_ACCOUNT_PROTONMAIL_SMTP_HOST:-127.0.0.1}
      - IMAP_ACCOUNT_PROTONMAIL_SMTP_PORT=${IMAP_ACCOUNT_PROTONMAIL_SMTP_PORT:-1025}
      - IMAP_ACCOUNT_GMAIL2_EMAIL=${IMAP_ACCOUNT_GMAIL2_EMAIL}
      - IMAP_ACCOUNT_GMAIL2_IMAP_HOST=${IMAP_ACCOUNT_GMAIL2_IMAP_HOST:-imap.gmail.com}
      - IMAP_ACCOUNT_GMAIL2_IMAP_PORT=${IMAP_ACCOUNT_GMAIL2_IMAP_PORT:-993}
      - IMAP_ACCOUNT_GMAIL2_IMAP_USER=${IMAP_ACCOUNT_GMAIL2_IMAP_USER}
      - IMAP_ACCOUNT_GMAIL2_IMAP_PASSWORD=${IMAP_ACCOUNT_GMAIL2_IMAP_PASSWORD}
      - IMAP_ACCOUNT_GMAIL2_SMTP_HOST=${IMAP_ACCOUNT_GMAIL2_SMTP_HOST:-smtp.gmail.com}
      - IMAP_ACCOUNT_GMAIL2_SMTP_PORT=${IMAP_ACCOUNT_GMAIL2_SMTP_PORT:-587}
      # Telegram notifications
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_SUPERGROUP_ID=${TELEGRAM_SUPERGROUP_ID}
      - TOPIC_EMAIL_ID=${TOPIC_EMAIL_ID}
      - TOPIC_ACTIONS_ID=${TOPIC_ACTIONS_ID}
      - TOPIC_SYSTEM_ID=${TOPIC_SYSTEM_ID}
      # LLM
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      # Pipeline controls
      - PIPELINE_ENABLED=${PIPELINE_ENABLED:-false}
      - MAX_EMAILS_PER_HOUR=${MAX_EMAILS_PER_HOUR:-100}
      - MAX_CLAUDE_COST_PER_DAY=${MAX_CLAUDE_COST_PER_DAY:-50}
      - MAX_ATTACHMENT_SIZE_MB=${MAX_ATTACHMENT_SIZE_MB:-50}
      - MAX_TOTAL_ATTACHMENTS_MB=${MAX_TOTAL_ATTACHMENTS_MB:-200}
      # Mainteneur
      - MAINTENEUR_EMAILS=${MAINTENEUR_EMAILS}
      - OWNER_USER_ID=${OWNER_USER_ID}
      # Config
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      friday-network:
        ipv4_address: 172.20.0.26
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "/app/healthcheck.py"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  # ============================================
  # IMAP Fetcher - Detection nouveaux emails (D25)
  # Remplace EmailEngine webhooks
  # RAM: ~200 Mo (aioimaplib + Presidio client)
  # ============================================
  imap-fetcher:
    build:
      context: .
      dockerfile: Dockerfile.imap-fetcher
    container_name: friday-imap-fetcher
    restart: unless-stopped
    environment:
      # Redis (meme user que email-processor)
      - REDIS_URL=redis://friday_email:${REDIS_EMAIL_PASSWORD}@redis:6379/0
      # IMAP accounts (4 comptes configures)
      - IMAP_ACCOUNT_GMAIL1_EMAIL=${IMAP_ACCOUNT_GMAIL1_EMAIL}
      - IMAP_ACCOUNT_GMAIL1_IMAP_HOST=${IMAP_ACCOUNT_GMAIL1_IMAP_HOST:-imap.gmail.com}
      - IMAP_ACCOUNT_GMAIL1_IMAP_PORT=${IMAP_ACCOUNT_GMAIL1_IMAP_PORT:-993}
      - IMAP_ACCOUNT_GMAIL1_IMAP_USER=${IMAP_ACCOUNT_GMAIL1_IMAP_USER}
      - IMAP_ACCOUNT_GMAIL1_IMAP_PASSWORD=${IMAP_ACCOUNT_GMAIL1_IMAP_PASSWORD}
      - IMAP_ACCOUNT_GMAIL1_USE_IDLE=${IMAP_ACCOUNT_GMAIL1_USE_IDLE:-true}
      - IMAP_ACCOUNT_UNIVERSITE_EMAIL=${IMAP_ACCOUNT_UNIVERSITE_EMAIL}
      - IMAP_ACCOUNT_UNIVERSITE_IMAP_HOST=${IMAP_ACCOUNT_UNIVERSITE_IMAP_HOST:-imap.gmail.com}
      - IMAP_ACCOUNT_UNIVERSITE_IMAP_PORT=${IMAP_ACCOUNT_UNIVERSITE_IMAP_PORT:-993}
      - IMAP_ACCOUNT_UNIVERSITE_IMAP_USER=${IMAP_ACCOUNT_UNIVERSITE_IMAP_USER}
      - IMAP_ACCOUNT_UNIVERSITE_IMAP_PASSWORD=${IMAP_ACCOUNT_UNIVERSITE_IMAP_PASSWORD}
      - IMAP_ACCOUNT_UNIVERSITE_USE_IDLE=${IMAP_ACCOUNT_UNIVERSITE_USE_IDLE:-true}
      - IMAP_ACCOUNT_PROTONMAIL_EMAIL=${IMAP_ACCOUNT_PROTONMAIL_EMAIL}
      - IMAP_ACCOUNT_PROTONMAIL_IMAP_HOST=${IMAP_ACCOUNT_PROTONMAIL_IMAP_HOST}
      - IMAP_ACCOUNT_PROTONMAIL_IMAP_PORT=${IMAP_ACCOUNT_PROTONMAIL_IMAP_PORT:-1144}
      - IMAP_ACCOUNT_PROTONMAIL_IMAP_USER=${IMAP_ACCOUNT_PROTONMAIL_IMAP_USER}
      - IMAP_ACCOUNT_PROTONMAIL_IMAP_PASSWORD=${IMAP_ACCOUNT_PROTONMAIL_IMAP_PASSWORD}
      - IMAP_ACCOUNT_PROTONMAIL_USE_IDLE=${IMAP_ACCOUNT_PROTONMAIL_USE_IDLE:-false}
      - IMAP_ACCOUNT_GMAIL2_EMAIL=${IMAP_ACCOUNT_GMAIL2_EMAIL}
      - IMAP_ACCOUNT_GMAIL2_IMAP_HOST=${IMAP_ACCOUNT_GMAIL2_IMAP_HOST:-imap.gmail.com}
      - IMAP_ACCOUNT_GMAIL2_IMAP_PORT=${IMAP_ACCOUNT_GMAIL2_IMAP_PORT:-993}
      - IMAP_ACCOUNT_GMAIL2_IMAP_USER=${IMAP_ACCOUNT_GMAIL2_IMAP_USER}
      - IMAP_ACCOUNT_GMAIL2_IMAP_PASSWORD=${IMAP_ACCOUNT_GMAIL2_IMAP_PASSWORD}
      - IMAP_ACCOUNT_GMAIL2_USE_IDLE=${IMAP_ACCOUNT_GMAIL2_USE_IDLE:-true}
      # Fetcher config
      - IMAP_IDLE_RENEW_SECONDS=${IMAP_IDLE_RENEW_SECONDS:-1500}
      - IMAP_POLL_INTERVAL=${IMAP_POLL_INTERVAL:-60}
      - IMAP_IDLE_SILENCE_TIMEOUT=${IMAP_IDLE_SILENCE_TIMEOUT:-1800}
      - IMAP_SEEN_UIDS_TTL_DAYS=${IMAP_SEEN_UIDS_TTL_DAYS:-7}
      - MAX_ATTACHMENT_SIZE_MB=${MAX_ATTACHMENT_SIZE_MB:-25}
      # Config
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./config/certs:/app/config/certs:ro
    networks:
      friday-network:
        ipv4_address: 172.20.0.36
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 500M
        reservations:
          memory: 200M
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/fetcher-alive && [ $$(( $$(date +%s) - $$(stat -c %Y /tmp/fetcher-alive 2>/dev/null || echo 0) )) -lt 120 ]"]
      interval: 60s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ============================================
  # Document Processor Stub - Consumer Redis Streams
  # Story 2.4 - Task 5 (MVP Epic 2)
  # ============================================
  document-processor-stub:
    build:
      context: ./services/document_processor
      dockerfile: Dockerfile
    container_name: friday-document-processor-stub
    restart: unless-stopped
    environment:
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-friday}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-friday}

      # Redis (ACL document_processor user)
      - REDIS_URL=redis://document_processor:${REDIS_DOCUMENT_PROCESSOR_PASSWORD}@redis:6379/0

      # Config optionnelle
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      friday-network:
        ipv4_address: 172.20.0.25
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os; os.kill(1, 0)'"]
      interval: 60s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ============================================
  # Calendar Sync Worker - Google Calendar Bidirectionnel
  # Story 7.2 - Sync automatique toutes les 30 min
  # RAM: ~300 Mo
  # ============================================
  calendar-sync:
    build:
      context: .
      dockerfile: services/calendar_sync/Dockerfile
    container_name: friday-calendar-sync
    restart: unless-stopped
    environment:
      # Database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-friday}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-friday}

      # Redis (partagé avec email processor pour simplifier ACL Day 1)
      - REDIS_URL=redis://friday_email:${REDIS_EMAIL_PASSWORD}@redis:6379/0

      # Calendar configuration
      - CALENDAR_CONFIG_PATH=/app/config/calendar_config.yaml

      # Google OAuth2 credentials
      - GOOGLE_CALENDAR_TOKEN_PATH=/app/config/google_token.json
      - GOOGLE_CALENDAR_TOKEN_ENC_PATH=/app/config/google_token.json.enc
      - GOOGLE_CLIENT_SECRET_PATH=/app/config/google_client_secret.json
      - GOOGLE_CALENDAR_OAUTH_MODE=console  # Use console mode for headless VPS

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./config:/app/config:ro  # Read-only access to config files
    networks:
      friday-network:
        ipv4_address: 172.20.0.27
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 500M
        reservations:
          memory: 300M
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import redis, os; r = redis.from_url(os.getenv('REDIS_URL')); assert r.get('calendar:last_sync')\""]
      interval: 5m
      timeout: 10s
      start_period: 2m
      retries: 3
